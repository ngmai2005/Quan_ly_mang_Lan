<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Dashboard LOGLAN</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>üìä Dashboard Gi√°m s√°t T·∫•n c√¥ng M·∫°ng</h1>

    <!-- ==== C·∫¢NH B√ÅO ==== -->
    <section>
      <h2>C·∫£nh b√°o g·∫ßn ƒë√¢y</h2>
      {% if alerts %}
      <div class="table-wrap scroll" id="alertsScroll">
        <table id="alerts_table">
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>IP ngu·ªìn</th>
              <th>S·ªë g√≥i</th>
              <th>M·ª©c ƒë·ªô nguy hi·ªÉm</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            {% for a in alerts %}
            {% set conf = a.get('confidence', 0.0)|float %}
            <tr>
              <td>{{ a.timestamp }}</td>
              <td>{{ a.src_ip }}</td>
              <td>{{ a.packet_count }}</td>
              <td>
                {% if conf > 0.8 %}
                  <span style="color:red;font-weight:bold;">R·∫•t cao ({{ '%.2f' % conf }})</span>
                {% elif conf > 0.5 %}
                  <span style="color:orange;">Trung b√¨nh ({{ '%.2f' % conf }})</span>
                {% else %}
                  <span style="color:green;">Th·∫•p ({{ '%.2f' % conf }})</span>
                {% endif %}
              </td>
              <td><button class="block-btn" data-ip="{{ a.src_ip }}">Ch·∫∑n</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p>‚úÖ Kh√¥ng c√≥ c·∫£nh b√°o</p>
      {% endif %}
    </section>


    <!-- ==== BI·ªÇU ƒê·ªí ==== -->
    <section style="margin-top:30px;">
      <h2>Bi·ªÉu ƒë·ªì: S·ªë c·∫£nh b√°o theo IP</h2>
      <canvas id="chartAlerts" width="800" height="300"></canvas>
    </section>

    <!-- ==== IP B·ªä CH·∫∂N ==== -->
    <section style="margin-top:30px;">
      <h2>Danh s√°ch IP ƒë√£ ch·∫∑n</h2>
      <div class="scroll" id="blockedScroll">
        <ul id="blockedList">
          {% for b in blocked %}
            <li>{{ b }} <button class="unblock-btn" data-ip="{{ b }}">B·ªè ch·∫∑n</button></li>
          {% else %}
            <li>Ch∆∞a c√≥ IP b·ªã ch·∫∑n</li>
          {% endfor %}
        </ul>
      </div>
    </section>


    <hr>
    <a href="/">‚Üê Upload PCAP kh√°c</a>
  </div>

<script>
async function fetchAlerts(){
  const r = await fetch('/api/alerts');
  return await r.json();
}
async function fetchBlocked(){
  const r = await fetch('/api/blocked');
  return await r.json();
}
function makeChart(labels, data){
  const ctx = document.getElementById('chartAlerts').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: { labels: labels, datasets: [{ label: 'S·ªë c·∫£nh b√°o', data: data }] },
    options: { responsive: true }
  });
}
window.addEventListener('DOMContentLoaded', async ()=> {
  const alerts = await fetchAlerts();
  const count = {};
  alerts.forEach(a => { count[a.src_ip] = (count[a.src_ip]||0) + 1; });
  const labels = Object.keys(count);
  const data = labels.map(l=>count[l]);
  if(labels.length) makeChart(labels, data);

  // N√∫t ch·∫∑n
  document.querySelectorAll('.block-btn').forEach(btn=>{
    btn.onclick = async ()=> {
      const ip = btn.dataset.ip;
      const simulate = confirm("Ch·∫°y ch·∫ø ƒë·ªô gi·∫£ l·∫≠p? (OK=Simulate, Cancel=Th·ª±c thi th·∫≠t - c·∫ßn quy·ªÅn Admin)");
      const res = await fetch('/api/block', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ip, simulate})
      });
      const j = await res.json();
      alert(j.message || JSON.stringify(j));
      if(j.ok) location.reload();
    };
  });

  // N√∫t b·ªè ch·∫∑n
  document.querySelectorAll('.unblock-btn').forEach(btn=>{
    btn.onclick = async ()=> {
      const ip = btn.dataset.ip;
      const simulate = confirm("Ch·∫°y ch·∫ø ƒë·ªô gi·∫£ l·∫≠p? (OK=Simulate, Cancel=Th·ª±c thi th·∫≠t - c·∫ßn quy·ªÅn Admin)");
      const res = await fetch('/api/unblock', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ip, simulate})
      });
      const j = await res.json();
      alert(j.message || JSON.stringify(j));
      if(j.ok) location.reload();
    };
  });
});
</script>

</body>
</html>
